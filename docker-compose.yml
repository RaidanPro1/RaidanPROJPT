
version: '3.8'

# ðŸ‡¾ðŸ‡ª RaidanPro Hybrid Architecture v3.1
# Network: Sovereign Net (172.28.0.0/16)
# Services: Containerized Only (Ollama is Native on Host 172.28.0.1)

networks:
  sovereign_net:
    external: true # Created by launch_wizard.sh

services:
  # --- Layer 1: The Gatekeeper ---
  traefik:
    image: traefik:v3.0
    container_name: raidan_gateway
    restart: always
    command:
      - "--api.insecure=false"
      - "--providers.docker=true"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      sovereign_net:
        ipv4_address: 172.28.0.2

  # --- Layer 2: The Vault ---
  postgres:
    image: pgvector/pgvector:pg16
    container_name: raidan_db
    restart: always
    environment:
      POSTGRES_USER: raidan_root
      POSTGRES_DB: raidan_core
      # Password injected via ENV file generated by installer
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
    networks:
      sovereign_net:
        ipv4_address: 172.28.0.10

  redis:
    image: redis/redis-stack:latest
    container_name: raidan_cache
    restart: always
    networks:
      sovereign_net:
        ipv4_address: 172.28.0.12

  # --- Layer 3: Application Logic ---
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: raidan_api
    restart: always
    environment:
      # Connect to NATIVE Ollama via Gateway IP
      - OLLAMA_HOST=http://172.28.0.1:11434
      - DATABASE_URL=postgresql://raidan_root:${DB_PASS}@172.28.0.10:5432/raidan_core
    depends_on:
      - postgres
    networks:
      sovereign_net:
        ipv4_address: 172.28.0.30
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.api.rule=Host(`api.raidan.pro`)"

  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    container_name: raidan_ui
    restart: always
    depends_on:
      - backend
    networks:
      sovereign_net:
        ipv4_address: 172.28.0.32
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.ui.rule=Host(`host.raidan.pro`, `ai.raidan.pro`)"
