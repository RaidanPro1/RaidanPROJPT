version: '3.8'

# ðŸ‡¾ðŸ‡ª YemenJPT Sovereign Microservices Architecture v2.0
# Networks: yemenjpt-net (172.20.0.0/16)
# Ports: Gateway(8000), ImageLab(8081), AudioLab(8082), VideoLab(8083), AI-Proxy(4000), VectorDB(6333)

networks:
  yemenjpt-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  qdrant_data:
  postgres_data:
  minio_data:

services:
  # 1. The Gateway (Orchestrator) - FastAPI
  gateway:
    build: ./backend
    container_name: yjpt_gateway
    ports:
      - "8000:8000"
    environment:
      - IMAGE_LAB_URL=http://172.20.0.81:8080/mklab-iti
      - AUDIO_LAB_URL=http://172.20.0.82:8082
      - AI_GATEWAY_URL=http://172.20.0.40:4000
    networks:
      yemenjpt-net:
        ipv4_address: 172.20.0.10

  # 2. Image Forensics Lab - Java 8 + Tomcat 9
  image-lab:
    image: tomcat:9-jdk8-openjdk-slim
    container_name: yjpt_image_lab
    ports:
      - "8081:8080"
    volumes:
      - ./labs/image/mklab.war:/usr/local/tomcat/webapps/mklab-iti.war
      - ./labs/image/libs/libExportDCT.so:/usr/lib/libExportDCT.so
    networks:
      yemenjpt-net:
        ipv4_address: 172.20.0.81

  # 3. Audio Forensics Lab - Python 3.9 + Demucs
  audio-lab:
    build: ./labs/audio
    container_name: yjpt_audio_lab
    ports:
      - "8082:8082"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    networks:
      yemenjpt-net:
        ipv4_address: 172.20.0.82

  # 4. Video Intelligence Lab - Python 3.10 + Video-LLaVA
  video-lab:
    build: ./labs/video
    container_name: yjpt_video_lab
    ports:
      - "8083:8083"
    networks:
      yemenjpt-net:
        ipv4_address: 172.20.0.83

  # 5. AI Gateway - LiteLLM
  ai-gateway:
    image: ghcr.io/berriai/litellm:main-latest
    container_name: yjpt_ai_proxy
    ports:
      - "4000:4000"
    environment:
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - OLLAMA_API_BASE=http://172.20.0.1:11434
    networks:
      yemenjpt-net:
        ipv4_address: 172.20.0.40

  # 6. Context Engine - Qdrant Vector DB
  qdrant:
    image: qdrant/qdrant:latest
    container_name: yjpt_vector_db
    ports:
      - "6333:6333"
    volumes:
      - qdrant_data:/qdrant/storage
    networks:
      yemenjpt-net:
        ipv4_address: 172.20.0.60

  # Frontend UI
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    container_name: yjpt_ui
    ports:
      - "80:80"
    networks:
      yemenjpt-net:
        ipv4_address: 172.20.0.32